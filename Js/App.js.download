jQuery.fn.animateRotate = function(angle, duration, easing, complete) {
  var args = jQuery.speed(duration, easing, complete);
  var step = args.step;
  return this.each(function(i, e) {
    args.complete = jQuery.proxy(args.complete, e);
    args.step = function(now) {
      jQuery.style(e, 'transform', 'rotate(' + now + 'deg)');
      if (step) return step.apply(e, arguments);
    };

    jQuery({deg: 0}).animate({deg: angle}, args);
  });
};

jQuery.fn.serializeObject = function() {
  var o = {};
  var a = this.serializeArray();
  jQuery.each(a, function() {
    var currentValue = ((this.value == null) || (!this.value.length) || this.value == 'null' ? '' : this.value);
    if (o[this.name] !== undefined) {
      if (!o[this.name].push) {
        o[this.name] = [ o[this.name] ];
      }
      o[this.name].push(currentValue || '');
    } else {
      o[this.name] = currentValue || '';
    }
  });
  return o;
};

String.prototype.startsWith = function(prefix) {
  return (this.substr(0, prefix.length) === prefix);
};

function commonFormatDate(value, row, index) {
  if (value != null) {
    var d = new Date(value), dformat = [ (d.getFullYear()),
        (d.getMonth() + 1).padLeft(), d.getDate().padLeft() ].join('/');

    return dformat;
  }
}

var WtmecAppConfig = (function() {
  var wtmecWebAppLoadingHTMLTemplat = '';
  wtmecWebAppLoadingHTMLTemplat += '<div style="display:none;" id="loadingPopup">';
  wtmecWebAppLoadingHTMLTemplat += '  <div class="loading_mask"></div>';
  wtmecWebAppLoadingHTMLTemplat += '  <div class="loading_popup">';
  wtmecWebAppLoadingHTMLTemplat += '    <div class="loading_content">';
  wtmecWebAppLoadingHTMLTemplat += '      <div class="loading_box">';
  wtmecWebAppLoadingHTMLTemplat += '        <span class="glyphicon glyphicon-time"> </span> Please Wait';
  wtmecWebAppLoadingHTMLTemplat += '        <div class="progress">';
  wtmecWebAppLoadingHTMLTemplat += '          <div class="progress-bar progress-bar-striped active" style="width: 100%"></div>';
  wtmecWebAppLoadingHTMLTemplat += '        </div>';
  wtmecWebAppLoadingHTMLTemplat += '      </div>';
  wtmecWebAppLoadingHTMLTemplat += '    </div>';
  wtmecWebAppLoadingHTMLTemplat += '  </div>';
  wtmecWebAppLoadingHTMLTemplat += '</div>';

  var wtmecWebAppLoadingCSSTemplate = '<style>';

  wtmecWebAppLoadingCSSTemplate += 'div.loading_mask {';
  wtmecWebAppLoadingCSSTemplate += '  width: 100%;';
  wtmecWebAppLoadingCSSTemplate += '  height: 100%;';
  wtmecWebAppLoadingCSSTemplate += '    position: fixed;';
  wtmecWebAppLoadingCSSTemplate += '    background: #fff;';
  wtmecWebAppLoadingCSSTemplate += '    filter: alpha(opacity = 50);';
  wtmecWebAppLoadingCSSTemplate += '  opacity: 0.5;';
  wtmecWebAppLoadingCSSTemplate += '  _zoom: 1;';
  wtmecWebAppLoadingCSSTemplate += '  z-index: 9999;';
  wtmecWebAppLoadingCSSTemplate += '  top: 0;';
  wtmecWebAppLoadingCSSTemplate += '  left: 0;';
  wtmecWebAppLoadingCSSTemplate += '}';

  wtmecWebAppLoadingCSSTemplate += 'div.loading_popup {';
  wtmecWebAppLoadingCSSTemplate += '  width: 100%;';
  wtmecWebAppLoadingCSSTemplate += '  height: 100%;';
  wtmecWebAppLoadingCSSTemplate += '  position: fixed;';
  wtmecWebAppLoadingCSSTemplate += '  top: 0;';
  wtmecWebAppLoadingCSSTemplate += '  overflow-y: auto;';
  wtmecWebAppLoadingCSSTemplate += '  z-index: 99999;';
  wtmecWebAppLoadingCSSTemplate += '}';

  wtmecWebAppLoadingCSSTemplate += 'div.loading_popup .loading_content {';
  wtmecWebAppLoadingCSSTemplate += '  height: 80px;';
  wtmecWebAppLoadingCSSTemplate += '  width: 190px;';
  wtmecWebAppLoadingCSSTemplate += '  margin: -40px auto;'
  wtmecWebAppLoadingCSSTemplate += '  background: #f5f5f5;'
  wtmecWebAppLoadingCSSTemplate += '  box-shadow: 0 0 30px rgba(0, 0, 0, 0.25);';
  wtmecWebAppLoadingCSSTemplate += '  position: relative;';
  wtmecWebAppLoadingCSSTemplate += '  top: 50%;';
  wtmecWebAppLoadingCSSTemplate += '  border-radius: 10px;';
  wtmecWebAppLoadingCSSTemplate += '}'

  wtmecWebAppLoadingCSSTemplate += 'div.loading_popup .loading_content .loading_box {';
  wtmecWebAppLoadingCSSTemplate += '  padding: 20px 10px 0 10px;';
  wtmecWebAppLoadingCSSTemplate += '}';

  wtmecWebAppLoadingCSSTemplate += 'div.loading_popup .loading_content .loading_box img {';
  wtmecWebAppLoadingCSSTemplate += '  display: block;';
  wtmecWebAppLoadingCSSTemplate += '  margin: 0px auto;';
  wtmecWebAppLoadingCSSTemplate += '}';

  wtmecWebAppLoadingCSSTemplate += 'div.loading_popup .loading_content .loading_box p {';
  wtmecWebAppLoadingCSSTemplate += '  font-size: 15px;';
  wtmecWebAppLoadingCSSTemplate += '  color: #6e828c;';
  wtmecWebAppLoadingCSSTemplate += '  letter-spacing: 1px;';
  wtmecWebAppLoadingCSSTemplate += '  text-align: center;';
  wtmecWebAppLoadingCSSTemplate += '  padding: 15px 0 0 0;';
  wtmecWebAppLoadingCSSTemplate += '}<style>';
  var instance;

  var bootboxOpenCounter = 0;

  var instanceCreate = function() {
    var baseUrl = jQuery('#pdcContextPath').html();
    var env = jQuery('#env').html();
    var init = function() {

      addGlobalFunction();

      jQuery('body').append(wtmecWebAppLoadingCSSTemplate);
      jQuery('body').append(wtmecWebAppLoadingHTMLTemplat);

      globalAjaxSetting();

      fixedBootboxMultiPopup();

    };

    var addGlobalFunction = function() {
      Number.prototype.padLeft = function(base, chr) {
        var len = (String(base || 10).length - String(this).length) + 1;
        return len > 0 ? new Array(len).join(chr || '0') + this : this;
      }
    }

    var fixedBootboxMultiPopup = function() {
      jQuery(document).on('shown.bs.modal', function() {
        bootboxOpenCounter++;
      });
      jQuery(document).on('hidden.bs.modal', function() {
        bootboxOpenCounter--;
        if (bootboxOpenCounter >= 1) {
          jQuery('body').addClass('modal-open');
        }
      });
    };

    var globalAjaxSetting = function() {
      jQuery(document).ajaxError(function(event, jqXHR, settings, thrownError) {
//
        if (jqXHR.status === 0) {
////        bootbox.alert('Not connect.n Verify Network.');
//        } else if (jqXHR.status == 404) {
//          bootbox.alert('Requested page not found. [404]');
//        } else if (jqXHR.status == 500) { 
////          bootbox.alert('Internal Server Error [500].');
//          bootbox.alert('Opps! Internal Server Error, Please contact MIS MarkYeh(8203) <br/>Error Msg <br/>' +jqXHR.responseText);
//        } else if (thrownError === 'parsererror') {
////          bootbox.alert('Requested JSON parse failed.');
//        } else if (jqXHR.status == 401) {
//          bootbox.alert('Your session has expired. Please click OK to refresh current page!', function() {
//            window.location.reload(true);
//          });
//        } else if (thrownError === 'abort') {
////          bootbox.alert('Ajax request aborted.');
        } else {
          bootbox.alert(jqXHR.responseText);
        }
        closeLoading();
      });
    };

    var showLoading = function() {
      jQuery('#loadingPopup').show();
    };

    var closeLoading = function() {
      jQuery('#loadingPopup').hide();
    };

    var getPdcContextPath = function() {
      return jQuery('#pdcContextPath').html();
    };

    var commonFormatLoadingMessage = function() {
      return '<div>' + 
      '<div class="loading_mask" style="position:absolute"></div>' + 
      '<div class="loading_popup" style="position:absolute">' + 
      '  <div class="loading_content">' + 
      '    <div class="loading_box">' + 
      '      <span class="glyphicon glyphicon-time"> </span> Please Wait' +
      '      <div class="progress">' + 
      '        <div class="progress-bar progress-bar-striped active" style="width: 100%"></div>' + 
      '      </div>' +
      '    </div>' +
      '  </div>' + 
      '</div></div>';
    };

    var commonFormatNoMatches = function() {
      return '<p style="padding: 15px;text-align: left;color: #d44950;font-weight: bold">No matching records foundÔºÅ</p>';
    };

    var nullToEmpty = function(value) {
      return (value == null) || (!value.length) || value == 'null' ? '' : value;
    };
    
    var isBlank = function(value) {
      return nullToEmpty(value).length <= 0;
    };
    
    var encode = function(value) {
      return encodeURIComponent(nullToEmpty(value));
    };

    var commonDownloadPreparingMessage = function() {
      return 'We are preparing your report, please wait...';
    }

    var commonDownloadFailMessage = function() {
      return 'There was a problem generating your report, please try again.';
    }
    
    var commonDownloadUploadErrorFilePreparingMessage = function() {
      return 'Upload file format error, We are preparing your error report, please wait...';
    }

    return {
      init : init,
      showLoading : showLoading,
      closeLoading : closeLoading,
      getPdcContextPath : getPdcContextPath,
      nullToEmpty : nullToEmpty,
      isBlank : isBlank,
      commonFormatNoMatches : commonFormatNoMatches,
      commonFormatLoadingMessage : commonFormatLoadingMessage,
      commonDownloadPreparingMessage : commonDownloadPreparingMessage,
      commonDownloadFailMessage : commonDownloadFailMessage,
      encode : encode,
      baseUrl : baseUrl,
      env : env,
      commonDownloadUploadErrorFilePreparingMessage : commonDownloadUploadErrorFilePreparingMessage,
    }
  }

  return {
    getInstance : function() {
      if (!instance) {
        instance = instanceCreate();
      }
      return instance;
    }
  }

})();

var wtmecApp;

jQuery(function() {
  wtmecApp = WtmecAppConfig.getInstance();
  wtmecApp.init();
});
