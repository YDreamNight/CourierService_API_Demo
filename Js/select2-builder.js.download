var Select2Builder = function() {

  var instance;

  var createInstance = function() {

    var buildCustomer = function(id, multiple) {
      var option = wtmecSelect2.getSetting_v4({
        env : wtmecApp.env,
        type : {
          category : 'CUSTOMER',
          subCategory : 'INCLUDE_FILTER',
          includeFilter : [ 'C', 'T', 'K', 'S', 'B', 'P', '1', 'H', 'D', 'A' , 'R']
        }
      });
      option.placeholder = 'Search ' + jQuery(id).prev().html();
      if (multiple) {
        option.multiple = multiple;
      }

      jQuery(id).select2(option);
    };
    
    var buildCustomerWithoutFilter = function(id, multiple) {
      var option = wtmecSelect2.getSetting_v4({
        env : wtmecApp.env,
        type : {
          category : 'CUSTOMER',
          subCategory : 'GENERAL',
        }
      });
      option.placeholder = 'Search ' + jQuery(id).prev().html();
      if (multiple) {
        option.multiple = multiple;
      }

      jQuery(id).select2(option);
    };

    var buildCountry = function(id) {
      var option = wtmecSelect2.getSetting_v4({
        env : wtmecApp.env,
        type : {
          category: 'COUNTRY',
          subCategory: 'GENERAL'
        }
      });
      option.placeholder = 'Search ' + jQuery(id).prev().html();
      jQuery(id).select2(option);

    }
    
    var buildSoldTo = function(id, multiple) {
    	var option = wtmecSelect2.getSetting_v4({
            env : wtmecApp.env,
    	      type: {
    	          category: 'CUSTOMER',
          subCategory : 'INCLUDE_FILTER',
          includeFilter : ['A', 'C', 'H', 'T', 'K', 'S', 'B', 'P' ]
    	      },
    	      multiple : multiple
    	  });
    	option.placeholder = 'Search ' + jQuery(id).prev().html();
    	jQuery(id).select2(option);
   }
   
    var buildShipTo = function(id) {
      var option = wtmecSelect2.getSetting_v4({
        env : wtmecApp.env,
        type : {
          category : 'CUSTOMER',
          subCategory : 'INCLUDE_FILTER',
          includeFilter : [ 'C', 'T', 'K', 'S', 'B', 'P', '1' ]
        }
      });
      option.placeholder = 'Search ' + jQuery(id).prev().html();
      jQuery(id).select2(option);
    }

    var buildCustomerGroup = function(id) {
      var option = wtmecSelect2.getSetting_v4({
        env : wtmecApp.env,
        type : {
          category : 'CUSTOMER_GROUP',
          subCategory : 'GENERAL',
        }
      });
      option.placeholder = 'Search ' + jQuery(id).prev().html();

      jQuery(id).select2(option);
    };
    var buildVendorPn = function(id, multiple) {
      _buildPn(id, 'VENDOR_PN', multiple);
    };
    var buildVendorPn = function(id, multiple, ph1) {
      _buildPn(id, 'VENDOR_PN', multiple, ph1);
    };

    var _buildPn = function(id, subCategory, multiple) {
      var option = wtmecSelect2.getSetting_v4({
        env : wtmecApp.env,
        type : {
          category : 'MATERIAL', // required
          subCategory : subCategory,
        }
      });
      option.placeholder = 'Search ' + jQuery(id).prev().html();
      if (multiple) {
        option.multiple = multiple;
      }
      jQuery(id).select2(option);
    };

    var _buildPn = function(id, subCategory, multiple, ph1) {
      var option = wtmecSelect2.getSetting_v4({
        env : wtmecApp.env,
        type : {
          category : 'MATERIAL', // required
          subCategory : subCategory,
          ph1 : ph1,
        }
      });
      option.placeholder = 'Search ' + jQuery(id).prev().html();
      if (multiple) {
        option.multiple = multiple;
      }
      jQuery(id).select2(option);
    };

    var buildPopn = function(id) {
      var option = wtmecSelect2.getSetting_v4({
        env : wtmecApp.env,
        type : {
          category : 'MATERIAL', // required
          subCategory : 'PO_PN' // required
        }
      });
      option.placeholder = 'Search ' + jQuery(id).prev().html();

      jQuery(id).select2(option);
    };
    
    var buildBrand = function(id, multi) {
      var option = wtmecSelect2.getSetting_v4({
        env : wtmecApp.env,
        type : {
          category : 'PH',
          subCategory : 'GROUP',
        },
        placeholder:  'Search ' + jQuery(id).prev().html(),
        multiple: multi
      }, function(param){
          jQuery(id).select2(param);
        });
    };
    
    var buildVendor = function(id) {
      var option = wtmecSelect2.getSetting_v4({
        env : wtmecApp.env,
        type : {
          category: 'VENDOR',
          subCategory: 'GENERAL'
        }
      });
      option.placeholder = 'Search ' + jQuery(id).prev().html();

      jQuery(id).select2(option);
    };


    var buildWtpn = function(id) {
      var option = wtmecSelect2.getSetting_v4({
        env : wtmecApp.env,
        type : {
          category : 'MATERIAL',
          subCategory : 'WT_PN',
        }
      });
      option.placeholder = 'Search ' + jQuery(id).prev().html();

      jQuery(id).select2(option);
    };

    var buildUser = function(id) {
      var option = wtmecSelect2.getSetting_v4({
        env : wtmecApp.env,
        type : {
          category : 'USER',
          subCategory : 'NORMAL',
        },
        multiple : false
      });
      option.placeholder = 'Search ' + jQuery(id).prev().html();

      jQuery(id).select2(option);
    };
    
    var buildMultiUser = function(id) {
      var option = wtmecSelect2.getSetting_v4({
        env : wtmecApp.env,
        type : {
          category: 'USER',
          subCategory: 'NORMAL'
        }
      });
      option.placeholder = 'Search ' + jQuery(id).prev().html();
      var option = wtmecSelect2.getSetting_v4({
        env : wtmecApp.env,
        type : {
          category : 'USER',
          subCategory : 'NORMAL',
        },
        multiple : true
      });
      option.placeholder = 'Search ' + jQuery(id).prev().html();

      jQuery(id).select2(option);
    };


    var buildNormal = function(id, placeholder, allowClear) {
      if (placeholder === undefined || placeholder == null) {
        placeholder = '';
      }
      if (allowClear == undefined || allowClear == null) {
        allowClear = true;
      }
      jQuery(id).select2({
        theme : 'bootstrap',
        allowClear : allowClear,
        placeholder : placeholder
      })
    };

    var buildDynamic = function(param) {
      if (param.isAsync == null || param.isAsync == undefined) {
        param.isAsync = true;
      }

      if (param.placeholder == null || param.placeholder == undefined) {
        param.placeholder = "";
      }

      if (param.allowClear == null || param.allowClear == undefined) {
        param.allowClear = false;
      }

      if (param.minimumResultsForSearch == null
          || param.minimumResultsForSearch == undefined) {
        param.minimumResultsForSearch = 'Infinity'
      }

      jQuery.post(param.url, param.datas).done(function(resp) {
        var items = resp.items;
        var result = [];
        jQuery.each(items, function(index, value, desc) {
          result.push({
            id : value.id,
            text : value.text,
            desc : desc
          });
        });
        var domId = jQuery(param.id);
        if (param.id instanceof jQuery) {
          domId = param.id;
        }
        domId.select2({
          data : result,
          placeholder : param.placeholder,
          minimumResultsForSearch : param.minimumResultsForSearch,
          theme : 'bootstrap',
          allowClear : param.allowClear
        });
      });
    };

    var buildSearch = function(param) {
      if (param.ajaxParam == null || param.ajaxParam == undefined) {
        param.ajaxParam = function(params) {
          console.log(params);
          return {
            key : params.term,
            page : params.page || 1
          };
        }
      }

      if (param.delay == null || param.delay == undefined) {
        param.delay = 250;
      }

      if (param.inputLength == null || param.inputLength == undefined) {
        param.inputLength = 1;
      }

      if (param.placeholder == null || param.placeholder == undefined) {
        param.placeholder = "";
      }

      if (param.multiple == null || param.multiple == undefined) {
        param.multiple = false;
      }
      
      if (param.allowClear == null || param.allowClear == undefined) {
        param.allowClear = false;
      }


      var options = {
        ajax : {
          url : param.url,
          dataType : 'json',
          delay : param.delay,
          data : param.ajaxParam,
          processResults : function(data, params) {
            params.page = params.page || 1;
            return {
              results : data.items,
              pagination : {
                more : (params.page * 30) < data.totalCount
              }
            };
          },
          cache : false,
        },
        minimumInputLength : param.inputLength,
        placeholder : param.placeholder,
        multiple : param.multiple,
        allowClear : param.allowClear
      };

      if (param.noKeyIn == "Y") {
        options.minimumResultsForSearch = Infinity;
      }

      options.theme = "bootstrap";
      jQuery(param.id).select2(options);
    };

    return {
      buildCustomer : buildCustomer,
      buildCustomerWithoutFilter : buildCustomerWithoutFilter,
      buildCustomerGroup : buildCustomerGroup,
      buildPopn : buildPopn,
      buildWtpn : buildWtpn,
      buildUser : buildUser,
      buildMultiUser : buildMultiUser,
      buildNormal : buildNormal,
      buildDynamic : buildDynamic,
      buildSearch : buildSearch,
      buildVendorPn : buildVendorPn,
      buildVendor : buildVendor,
      buildCountry : buildCountry,
      buildSoldTo : buildSoldTo,
      buildBrand : buildBrand,
    }

  }

  return {
    getInstance : function() {
      if (!instance) {
        instance = createInstance();
      }
      return instance;
    }
  }
}();

var select2Builder;
jQuery(function() {
  select2Builder = Select2Builder.getInstance();
  // select2 plugin canâ€™t focus when we display it in boot box.
  // add this fix Select2 auto focus issue.
  jQuery.fn.modal.Constructor.prototype.enforceFocus = jQuery.noop;
})